# üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç webhook.refactored.ts

–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ flow –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–æ–¥—É–ª—å–Ω–æ–≥–æ webhook.

---

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞

```typescript
// 1. –ò–º–ø–æ—Ä—Ç—ã
import { Telegraf } from "telegraf";
import { config } from "../config/index.js";
import { middleware } from "../middleware/index.js";
import { handlers } from "../handlers/index.js";

// 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
const bot = new Telegraf<BotContext>(config.token);

// 3. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è middleware
bot.use(errorHandlerMiddleware);   // ‚Üê –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.use(loggingMiddleware);         // ‚Üê –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
bot.use(rateLimitMiddleware);       // ‚Üê –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞

// 4. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
bot.command("start", startHandler);
bot.command("help", helpHandler);
bot.command("idea", ideaHandler);
bot.command("contact", contactHandler);

// 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ (–¥–ª—è contact flow)
bot.on("text", handleContactFlow);

// 6. –≠–∫—Å–ø–æ—Ä—Ç serverless —Ñ—É–Ω–∫—Ü–∏–∏
export default async (req, res) => { ... }

// 7. –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
if (config.environment === "development") { ... }
```

---

## üîÑ Flow –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### Production (Vercel Webhook Mode)

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí Telegram ‚Üí Vercel
                            ‚Üì
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ  export default async (req)   ‚îÇ ‚Üê Entry point
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
                        ‚ñº
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ   bot.handleUpdate(req.body)  ‚îÇ ‚Üê Telegraf –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
                        ‚ñº
            ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
            ‚ïë      MIDDLEWARE CHAIN         ‚ïë
            ‚ïë   (–≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ –ø–æ—Ä—è–¥–∫—É!)   ‚ïë
            ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï§‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                        ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ               ‚îÇ               ‚îÇ
        ‚ñº               ‚ñº               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Error      ‚îÇ ‚îÇ   Logging    ‚îÇ ‚îÇ Rate Limit   ‚îÇ
‚îÇ  Handler     ‚îÇ ‚îÇ  Middleware  ‚îÇ ‚îÇ  Middleware  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                ‚îÇ                ‚îÇ
       ‚îÇ  try/catch     ‚îÇ  Log request   ‚îÇ  Check limit
       ‚îÇ  –¥–ª—è –≤—Å–µ—Ö      ‚îÇ  + duration    ‚îÇ  Max 10/min
       ‚îÇ                ‚îÇ                ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
                        ‚ñº
            ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
            ‚ïë     COMMAND ROUTER            ‚ïë
            ‚ïë   (Telegraf –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç)       ‚ïë
            ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï§‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                        ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ               ‚îÇ               ‚îÇ               ‚îÇ
        ‚ñº               ‚ñº               ‚ñº               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  /start      ‚îÇ ‚îÇ  /help       ‚îÇ ‚îÇ  /idea       ‚îÇ ‚îÇ  /contact    ‚îÇ
‚îÇ  Handler     ‚îÇ ‚îÇ  Handler     ‚îÇ ‚îÇ  Handler     ‚îÇ ‚îÇ  Handler     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                ‚îÇ                ‚îÇ                ‚îÇ
       ‚ñº                ‚ñº                ‚ñº                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç   ‚îÇ ‚îÇ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç   ‚îÇ ‚îÇ   –í—ã–∑—ã–≤–∞–µ—Ç   ‚îÇ ‚îÇ  –ó–∞–ø—É—Å–∫–∞–µ—Ç   ‚îÇ
‚îÇ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ  ‚îÇ ‚îÇ   —Å–ø—Ä–∞–≤–∫—É    ‚îÇ ‚îÇ  aiService   ‚îÇ ‚îÇ contact flow ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                ‚îÇ                ‚îÇ                ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
                        ‚ñº
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ      ctx.reply(message)       ‚îÇ ‚Üê –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
                        ‚ñº
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ    res.status(200).json()     ‚îÇ ‚Üê –û—Ç–≤–µ—Ç Telegram
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
                        ‚ñº
                   –§—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
                   (serverless "–∑–∞—Å—ã–ø–∞–µ—Ç")
```

### Development (Local Polling Mode)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  npm run dev                          ‚îÇ
‚îÇ  tsx watch api/webhook.refactored.ts  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  config.environment === "development" ‚îÇ ‚Üê –ü—Ä–æ–≤–µ—Ä–∫–∞
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ true
                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  bot.launch()                         ‚îÇ ‚Üê Long polling
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
        ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        ‚ïë  Bot Process      ‚ïë
        ‚ïë  –†–∞–±–æ—Ç–∞–µ—Ç         ‚ïë
        ‚ïë  –ø–æ—Å—Ç–æ—è–Ω–Ω–æ        ‚ïë
        ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï§‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                ‚îÇ
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ                     ‚îÇ
     ‚ñº                     ‚ñº
–û–ø—Ä–∞—à–∏–≤–∞–µ—Ç            –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
Telegram              —Å–æ–æ–±—â–µ–Ω–∏—è
–∫–∞–∂–¥—ã–µ N —Å–µ–∫          —á–µ—Ä–µ–∑ —Ç–æ—Ç –∂–µ
                      middleware chain
     ‚îÇ
     ‚îî‚îÄ‚Üí Ctrl+C ‚Üí bot.stop() ‚Üí –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
```

---

## üß© –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤ –¥–µ—Ç–∞–ª—è—Ö

### 1. Entry Point (—Å—Ç—Ä–æ–∫–∏ 56-77)

```typescript
export default async (req: any, res: any) => {
  // –≠—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è Vercel –ø—Ä–∏ –∫–∞–∂–¥–æ–º POST –æ—Ç Telegram

  if (req.method === "POST") {
    // Telegram webhook - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await bot.handleUpdate(req.body, res);
    res.status(200).json({ ok: true });
  } else if (req.method === "GET") {
    // Health check - –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
    res.status(200).json({
      status: "ok",
      message: "Tokobot is running! (Refactored)",
      version: "2.0.0",
    });
  }
};
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

1. Vercel –ø–æ–ª—É—á–∞–µ—Ç POST –æ—Ç Telegram
2. –í—ã–∑—ã–≤–∞–µ—Ç —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é —Å `req` –∏ `res`
3. `bot.handleUpdate()` –ø–µ—Ä–µ–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegraf
4. Telegraf –ø—Ä–æ–≥–æ–Ω—è–µ—Ç —á–µ—Ä–µ–∑ middleware chain
5. –í—ã–∑—ã–≤–∞–µ—Ç –Ω—É–∂–Ω—ã–π handler
6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 OK Telegram

### 2. Middleware Chain (—Å—Ç—Ä–æ–∫–∏ 31-34)

```typescript
bot.use(errorHandlerMiddleware); // 1Ô∏è‚É£
bot.use(loggingMiddleware); // 2Ô∏è‚É£
bot.use(rateLimitMiddleware); // 3Ô∏è‚É£
```

**–ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ö–†–ò–¢–ò–ß–ï–ù!**

#### 1Ô∏è‚É£ Error Handler (–ø–µ—Ä–≤—ã–π)

```typescript
// middleware/error-handler.ts
export const errorHandlerMiddleware = async (ctx, next) => {
  try {
    await next(); // ‚Üê –í—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Å–µ —á—Ç–æ –¥–∞–ª—å—à–µ
  } catch (error) {
    await handleError(ctx, error); // ‚Üê –õ–æ–≤–∏—Ç –í–°–ï –æ—à–∏–±–∫–∏
  }
};
```

**–ó–∞—á–µ–º –ø–µ—Ä–≤—ã–π:** –û–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –í–°–ï –æ—Å—Ç–∞–ª—å–Ω—ã–µ middleware –∏ handlers –≤ try-catch.

#### 2Ô∏è‚É£ Logging (–≤—Ç–æ—Ä–æ–π)

```typescript
// middleware/logging.ts
export const loggingMiddleware = async (ctx, next) => {
  logger.info(`Incoming message from user ${userId}`);
  const startTime = Date.now();

  await next(); // ‚Üê –í—ã–ø–æ–ª–Ω—è–µ—Ç handler

  const duration = Date.now() - startTime;
  logger.debug(`Processed in ${duration}ms`);
};
```

**–ó–∞—á–µ–º –≤—Ç–æ—Ä–æ–π:** –õ–æ–≥–∏—Ä—É–µ—Ç –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Å timing.

#### 3Ô∏è‚É£ Rate Limit (—Ç—Ä–µ—Ç–∏–π)

```typescript
// middleware/rate-limit.ts
export const rateLimitMiddleware = async (ctx, next) => {
  const userLimit = rateLimitStore.get(userId);

  if (userLimit.count >= MAX_REQUESTS) {
    await ctx.reply("‚è±Ô∏è –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤");
    return; // ‚Üê –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç next() = –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç chain
  }

  userLimit.count++;
  await next(); // ‚Üê –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –µ—Å–ª–∏ –ª–∏–º–∏—Ç –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω
};
```

**–ó–∞—á–µ–º —Ç—Ä–µ—Ç–∏–π:** –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º handler.

**–í–∏–∑—É–∞–ª—å–Ω–æ:**

```
Request ‚Üí Error Handler (try) ‚Üí
          Logging (start timer) ‚Üí
          Rate Limit (check) ‚Üí
          Command Handler ‚Üí
          Rate Limit (done) ‚Üí
          Logging (log duration) ‚Üí
          Error Handler (catch if error)
```

### 3. Command Registration (—Å—Ç—Ä–æ–∫–∏ 36-40)

```typescript
bot.command("start", startHandler);
```

**–ß—Ç–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç:**

- –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç handler –¥–ª—è –∫–æ–º–∞–Ω–¥—ã `/start`
- –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç `/start` ‚Üí Telegraf –≤—ã–∑—ã–≤–∞–µ—Ç `startHandler`

**Handler structure:**

```typescript
// handlers/start.handler.ts
export const startHandler: CommandHandler = async (ctx) => {
  // ctx = –∫–æ–Ω—Ç–µ–∫—Å—Ç (user, message, reply –∏ —Ç.–¥.)
  await ctx.reply("–ü—Ä–∏–≤–µ—Ç!");
};
```

### 4. Text Handler (—Å—Ç—Ä–æ–∫–∞ 43)

```typescript
bot.on("text", handleContactFlow);
```

**–ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:**

- –ù–∞ –õ–Æ–ë–û–ï —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–µ –∫–æ–º–∞–Ω–¥—É)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è multi-step flow (contact form)

**–ü—Ä–∏–º–µ—Ä flow:**

```
User: /contact
Bot: –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?
      ‚Üì
User: –ò–≤–∞–Ω          ‚Üê bot.on("text") –ª–æ–≤–∏—Ç
Bot: –£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω
      ‚Üì
User: +123456       ‚Üê bot.on("text") –ª–æ–≤–∏—Ç
Bot: –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞
```

### 5. Unknown Message Handler (—Å—Ç—Ä–æ–∫–∏ 46-51)

```typescript
bot.on("message", async (ctx) => {
  await ctx.reply("‚ùì –ö–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞");
});
```

**–ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:**

- –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ handlers
- Fallback –¥–ª—è –≤—Å–µ—Ö –¥—Ä—É–≥–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### 6. Development Mode (—Å—Ç—Ä–æ–∫–∏ 82-106)

```typescript
if (config.environment === "development") {
  bot.launch(); // ‚Üê Long polling
}
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `NODE_ENV`
- –ï—Å–ª–∏ `"development"` ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç polling
- –ï—Å–ª–∏ –ù–ï development ‚Üí –ø—Ä–æ—Å—Ç–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é

---

## üîÄ Order of Execution

### –ü—Ä–∏–º–µ—Ä: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç `/idea sales`

```
1. Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –Ω–∞ Vercel
      ‚Üì
2. Vercel –≤—ã–∑—ã–≤–∞–µ—Ç: export default async (req, res)
      ‚Üì
3. bot.handleUpdate(req.body)
      ‚Üì
4. errorHandlerMiddleware: try {
      ‚Üì
5. loggingMiddleware: logger.info("Incoming message...")
      ‚Üì
6. rateLimitMiddleware: Check limit (OK)
      ‚Üì
7. Telegraf router: –í–∏–¥–∏—Ç "/idea" ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç ideaHandler
      ‚Üì
8. ideaHandler:
   - Parse args: topic = "sales"
   - await aiService.generateIdea({ topic: "sales" })
      ‚Üì
9. aiService:
   - –ü—ã—Ç–∞–µ—Ç—Å—è –≤—ã–∑–≤–∞—Ç—å HuggingFace AI
   - –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Üí fallback –Ω–∞ local ideas
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç idea
      ‚Üì
10. ideaHandler: await ctx.reply(idea)
      ‚Üì
11. rateLimitMiddleware: done
      ‚Üì
12. loggingMiddleware: logger.debug("Processed in 1234ms")
      ‚Üì
13. errorHandlerMiddleware: } // no errors
      ‚Üì
14. res.status(200).json({ ok: true })
      ‚Üì
15. Function terminates
```

---

## üí° –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

### 1. Middleware Chain

Middleware –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è **–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ** –≤ –ø–æ—Ä—è–¥–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.

```typescript
bot.use(middlewareA); // –í—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ø–µ—Ä–≤—ã–º
bot.use(middlewareB); // –í—ã–ø–æ–ª–Ω–∏—Ç—Å—è –≤—Ç–æ—Ä—ã–º
bot.use(middlewareC); // –í—ã–ø–æ–ª–Ω–∏—Ç—Å—è —Ç—Ä–µ—Ç—å–∏–º
```

### 2. next() Function

`await next()` –ø–µ—Ä–µ–¥–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–º—É middleware/handler.

```typescript
export const myMiddleware = async (ctx, next) => {
  // –î–æ handler
  console.log("Before");

  await next(); // ‚Üê –í—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π middleware/handler

  // –ü–æ—Å–ª–µ handler
  console.log("After");
};
```

### 3. Command Routing

Telegraf –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –Ω—É–∂–Ω—ã–π handler.

```typescript
bot.command("start", handler1); // /start ‚Üí handler1
bot.command("help", handler2); // /help ‚Üí handler2
bot.on("text", handler3); // –ª—é–±–æ–π —Ç–µ–∫—Å—Ç ‚Üí handler3
bot.on("message", handler4); // fallback –¥–ª—è –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ
```

### 4. Context (ctx)

–û–±—ä–µ–∫—Ç `ctx` —Å–æ–¥–µ—Ä–∂–∏—Ç:

- `ctx.from` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
- `ctx.message` - —Å–æ–æ–±—â–µ–Ω–∏–µ
- `ctx.reply()` - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
- `ctx.sendChatAction()` - –ø–æ–∫–∞–∑–∞—Ç—å "typing..."

### 5. Error Propagation

–û—à–∏–±–∫–∏ "–≤—Å–ø–ª—ã–≤–∞—é—Ç" –≤–≤–µ—Ä—Ö –ø–æ chain –ø–æ–∫–∞ –Ω–µ –ø–æ–π–º–∞–µ—Ç errorHandlerMiddleware.

```
Handler throws error
     ‚Üì
Rate Limit: no catch ‚Üí passes up
     ‚Üì
Logging: no catch ‚Üí passes up
     ‚Üì
Error Handler: catch! ‚Üí handleError()
```

---

## üÜö –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º

### –°—Ç–∞—Ä—ã–π webhook.ts (–º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π)

```typescript
// –í–°–Å –í –û–î–ù–û–ú –§–ê–ô–õ–ï
bot.command("start", async (ctx) => {
  try {
    // –õ–æ–≥–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã –∑–¥–µ—Å—å
    await ctx.reply("...");
  } catch (error) {
    console.error(error);
    await ctx.reply("–û—à–∏–±–∫–∞");
  }
});

bot.command("help", async (ctx) => {
  try {
    // –õ–æ–≥–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã –∑–¥–µ—Å—å
    await ctx.reply("...");
  } catch (error) {
    console.error(error);
    await ctx.reply("–û—à–∏–±–∫–∞");
  }
});

// ... –µ—â–µ 5 –∫–æ–º–∞–Ω–¥ —Å copy-paste error handling
```

**–ü—Ä–æ–±–ª–µ–º—ã:**

- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ (error handling –≤ –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥–µ)
- ‚ùå –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚ùå –ù–µ—Ç rate limiting
- ‚ùå –°–ª–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚ùå –í—Å–µ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ (195 —Å—Ç—Ä–æ–∫)

### –ù–æ–≤—ã–π webhook.refactored.ts (–º–æ–¥—É–ª—å–Ω—ã–π)

```typescript
// Middleware –¥–µ–ª–∞—é—Ç –≤—Å—é —Ä–∞–±–æ—Ç—É
bot.use(errorHandlerMiddleware); // Error handling –¥–ª—è –í–°–ï–•
bot.use(loggingMiddleware); // Logging –¥–ª—è –í–°–ï–•
bot.use(rateLimitMiddleware); // Rate limit –¥–ª—è –í–°–ï–•

// Handler —Ç–æ–ª—å–∫–æ —Å –ª–æ–≥–∏–∫–æ–π
bot.command("start", startHandler); // 1 —Å—Ç—Ä–æ–∫–∞!
bot.command("help", helpHandler); // 1 —Å—Ç—Ä–æ–∫–∞!
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π error handling
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ Rate limiting –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- ‚úÖ –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ 108 —Å—Ç—Ä–æ–∫ vs 195

---

## üéØ –ò—Ç–æ–≥–æ

**webhook.refactored.ts —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫:**

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è** (–ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ)
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç config
   - –°–æ–∑–¥–∞–µ—Ç bot instance
   - –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç middleware
   - –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç handlers

2. **–ù–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å** (Vercel webhook)
   - Vercel –≤—ã–∑—ã–≤–∞–µ—Ç export default —Ñ—É–Ω–∫—Ü–∏—é
   - bot.handleUpdate() –ø—Ä–æ–≥–æ–Ω—è–µ—Ç —á–µ—Ä–µ–∑ middleware chain
   - Middleware –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç (error, log, rate limit)
   - Router –≤—ã–∑—ã–≤–∞–µ—Ç –Ω—É–∂–Ω—ã–π handler
   - Handler –≤—ã–ø–æ–ª–Ω—è–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
   - –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   - –§—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è

3. **–í development —Ä–µ–∂–∏–º–µ** (–ª–æ–∫–∞–ª—å–Ω–æ)
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç polling
   - –ü–æ—Å—Ç–æ—è–Ω–Ω–æ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç Telegram
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ middleware chain
   - –†–∞–±–æ—Ç–∞–µ—Ç –¥–æ Ctrl+C

**–ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ:**

- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- Middleware –¥–ª—è cross-cutting concerns
- Handlers —Ç–æ–ª—å–∫–æ –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- Services –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
- –í—Å–µ –º–æ–¥—É–ª—å–Ω–æ –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ

---

–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2026-01-07
