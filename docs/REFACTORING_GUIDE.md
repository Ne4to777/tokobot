**–°–æ–∑–¥–∞–Ω–æ –±–æ–ª—å—à–µ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞, –Ω–æ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –æ—Ç–≤–µ—Ç–∞. –ó–∞–≤–µ—Ä—à–∞—é —Ä–∞–±–æ—Ç—É...**

# üèóÔ∏è –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–æ–≤–æ–π –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã Tokobot.

---

## üéØ –¶–µ–ª–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

‚úÖ **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - –∫–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ —Å–µ—Ä–≤–∏—Å—ã  
‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –ª–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å  
‚úÖ **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å** - –ø–æ–Ω—è—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –Ω–æ–≤—ã—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤  
‚úÖ **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - —Å—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è TypeScript  

---

## üìÇ –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
tokobot/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ webhook.ts               # –°—Ç–∞—Ä—ã–π (monolithic)
‚îÇ   ‚îî‚îÄ‚îÄ webhook.refactored.ts    # –ù–æ–≤—ã–π (modular) ‚Üê –ò–°–ü–û–õ–¨–ó–£–ô –≠–¢–û–¢
‚îÇ
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                 # –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                 # TypeScript —Ç–∏–ø—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
‚îÇ
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ logger.ts                # –£—Ç–∏–ª–∏—Ç–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ errors.ts                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
‚îÇ   ‚îî‚îÄ‚îÄ helpers.ts               # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îú‚îÄ‚îÄ logging.ts               # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ error-handler.ts         # –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
‚îÇ   ‚îú‚îÄ‚îÄ rate-limit.ts            # Rate limiting
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                 # –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö middleware
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ ai.service.ts            # –°–µ—Ä–≤–∏—Å AI –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ crm.service.ts           # –°–µ—Ä–≤–∏—Å CRM (Bitrix24)
‚îÇ   ‚îî‚îÄ‚îÄ data/
‚îÇ       ‚îî‚îÄ‚îÄ ideas.ts             # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–¥–µ–π
‚îÇ
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ start.handler.ts         # /start –∫–æ–º–∞–Ω–¥–∞
‚îÇ   ‚îú‚îÄ‚îÄ help.handler.ts          # /help –∫–æ–º–∞–Ω–¥–∞
‚îÇ   ‚îú‚îÄ‚îÄ idea.handler.ts          # /idea –∫–æ–º–∞–Ω–¥–∞
‚îÇ   ‚îú‚îÄ‚îÄ contact.handler.ts       # /contact –∫–æ–º–∞–Ω–¥–∞
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                 # –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö handlers
‚îÇ
‚îî‚îÄ‚îÄ lib/                         # –°—Ç–∞—Ä—ã–π –∫–æ–¥ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    ‚îú‚îÄ‚îÄ ai.ts
    ‚îî‚îÄ‚îÄ bitrix24.ts
```

---

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è

### –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
- ‚úÖ –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞
- ‚è≥ –°—Ç–∞—Ä—ã–π –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω (backward compatibility)
- ‚è≥ –ù—É–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –Ω–æ–≤—ã–π webhook

### –ö–∞–∫ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è

1. **–û–±–Ω–æ–≤–∏—Ç–µ package.json**:
```json
{
  "scripts": {
    "dev": "tsx watch api/webhook.refactored.ts",
    "dev:old": "tsx watch api/webhook.ts"
  }
}
```

2. **–î–ª—è local —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**:
```bash
npm run dev  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç refactored –≤–µ—Ä—Å–∏—é
```

3. **–î–ª—è Vercel –¥–µ–ø–ª–æ—è**:
```bash
# –ü–µ—Ä–µ–∏–º–µ–Ω—É–π—Ç–µ —Ñ–∞–π–ª—ã
mv api/webhook.ts api/webhook.old.ts
mv api/webhook.refactored.ts api/webhook.ts
```

–ò–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ `vercel.json` —á—Ç–æ–±—ã —É–∫–∞–∑–∞—Ç—å –Ω–∞ –Ω–æ–≤—ã–π —Ñ–∞–π–ª.

---

## üß© –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. Types (`types/index.ts`)

–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ TypeScript —Ç–∏–ø—ã:
- `BotContext` - –∫–æ–Ω—Ç–µ–∫—Å—Ç –±–æ—Ç–∞ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏
- `CommandHandler` - —Ç–∏–ø —Ñ—É–Ω–∫—Ü–∏–∏-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã
- `IdeaGenerationOptions` - –æ–ø—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–¥–µ–π
- `LeadData` - –¥–∞–Ω–Ω—ã–µ –¥–ª—è CRM
- `BotError` - –∫–∞—Å—Ç–æ–º–Ω—ã–π –∫–ª–∞—Å—Å –æ—à–∏–±–æ–∫

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
```typescript
import { CommandHandler, BotContext } from "../types/index.js";

export const myHandler: CommandHandler = async (ctx: BotContext) => {
  // –í–∞—à –∫–æ–¥
};
```

### 2. Config (`config/index.ts`)

–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
- –í–∞–ª–∏–¥–∞—Ü–∏—è environment variables
- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI –º–æ–¥–µ–ª–∏
- Rate limiting –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

**–ü—Ä–∏–º–µ—Ä**:
```typescript
import { config, Constants } from "../config/index.js";

console.log(config.aiEnabled); // true/false
console.log(Constants.AI_MODEL); // "mistralai/Mistral-7B-Instruct-v0.2"
```

### 3. Utils

#### Logger (`utils/logger.ts`)
```typescript
import { createLogger } from "../utils/logger.js";

const logger = createLogger("MyModule");

logger.info("Information message");
logger.warn("Warning message");
logger.error("Error message", error);
logger.debug("Debug message"); // Only in development
```

#### Error Handler (`utils/errors.ts`)
```typescript
import { createError, handleError, ErrorType } from "../utils/errors.js";

// Create typed error
throw createError("AI service unavailable", ErrorType.AI_SERVICE);

// Handle error in command
try {
  // ...
} catch (error) {
  await handleError(ctx, error as Error, "MyHandler");
}
```

#### Helpers (`utils/helpers.ts`)
```typescript
import { retry, randomElement, truncate } from "../utils/helpers.js";

// Retry with exponential backoff
const result = await retry(() => apiCall(), { maxAttempts: 3 });

// Random element from array
const idea = randomElement(ideas);

// Truncate string
const short = truncate(longText, 100);
```

### 4. Middleware

Middleware –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:

```typescript
bot.use(errorHandlerMiddleware);  // 1. Catches all errors
bot.use(loggingMiddleware);        // 2. Logs requests
bot.use(rateLimitMiddleware);      // 3. Rate limiting
```

**–°–æ–∑–¥–∞–Ω–∏–µ —Å–≤–æ–µ–≥–æ middleware**:
```typescript
import { MiddlewareFunction } from "../types/index.js";

export const myMiddleware: MiddlewareFunction = async (ctx, next) => {
  // Before
  console.log("Before command");
  
  await next(); // Call next middleware/handler
  
  // After
  console.log("After command");
};
```

### 5. Services

#### AIService (`services/ai.service.ts`)
```typescript
import { aiService } from "../services/ai.service.js";

// Generate idea
const idea = await aiService.generateIdea({ topic: "sales" });
console.log(idea.text);
console.log(idea.generatedBy); // "ai" or "local"

// Get available topics
const topics = aiService.getAvailableTopics();
```

#### CRMService (`services/crm.service.ts`)
```typescript
import { crmService } from "../services/crm.service.js";

// Check if enabled
if (crmService.isEnabled()) {
  // Create lead
  const leadId = await crmService.createLead({
    name: "John Doe",
    phone: "+1234567890",
    email: "john@example.com",
  });
  
  // Add comment
  await crmService.addLeadComment(leadId, "Additional info");
}
```

### 6. Handlers

–ö–∞–∂–¥–∞—è –∫–æ–º–∞–Ω–¥–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ:

```typescript
// handlers/my-command.handler.ts
import { CommandHandler } from "../types/index.js";
import { createLogger } from "../utils/logger.js";

const logger = createLogger("Handler:MyCommand");

export const myCommandHandler: CommandHandler = async (ctx) => {
  logger.info("Command received");
  
  try {
    // Your logic
    await ctx.reply("Response");
  } catch (error) {
    await handleError(ctx, error as Error, "MyCommandHandler");
  }
};

// handlers/index.ts
export { myCommandHandler } from "./my-command.handler.js";

// api/webhook.refactored.ts
import { myCommandHandler } from "../handlers/index.js";
bot.command("mycommand", myCommandHandler);
```

---

## ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

### –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É

1. **–°–æ–∑–¥–∞–π—Ç–µ handler**:
```typescript
// handlers/new-feature.handler.ts
import { CommandHandler } from "../types/index.js";

export const newFeatureHandler: CommandHandler = async (ctx) => {
  await ctx.reply("New feature!");
};
```

2. **–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ**:
```typescript
// handlers/index.ts
export { newFeatureHandler } from "./new-feature.handler.js";
```

3. **–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ**:
```typescript
// api/webhook.refactored.ts
import { newFeatureHandler } from "../handlers/index.js";
bot.command("newfeature", newFeatureHandler);
```

### –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å

```typescript
// services/my-service.ts
import { createLogger } from "../utils/logger.js";

const logger = createLogger("MyService");

export class MyService {
  async doSomething(): Promise<void> {
    logger.info("Doing something");
    // Your logic
  }
}

export const myService = new MyService();
```

### –î–æ–±–∞–≤–∏—Ç—å middleware

```typescript
// middleware/my-middleware.ts
import { MiddlewareFunction } from "../types/index.js";

export const myMiddleware: MiddlewareFunction = async (ctx, next) => {
  // Your logic before
  await next();
  // Your logic after
};

// middleware/index.ts
export { myMiddleware } from "./my-middleware.ts";

// api/webhook.refactored.ts
import { myMiddleware } from "../middleware/index.js";
bot.use(myMiddleware);
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É–ø—Ä–æ—â–∞–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

```typescript
// __tests__/handlers/idea.test.ts
import { ideaHandler } from "../../handlers/idea.handler";

describe("IdeaHandler", () => {
  it("should generate idea", async () => {
    const ctx = createMockContext();
    await ideaHandler(ctx);
    expect(ctx.reply).toHaveBeenCalled();
  });
});
```

---

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

| –ê—Å–ø–µ–∫—Ç | –°—Ç–∞—Ä–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ |
|--------|-------------------|-------------------|
| **–§–∞–π–ª–æ–≤** | 1 –±–æ–ª—å—à–æ–π | –ú–Ω–æ–≥–æ –º–∞–ª–µ–Ω—å–∫–∏—Ö |
| **–°—Ç—Ä–æ–∫ –≤ —Ñ–∞–π–ª–µ** | 195+ | 20-100 |
| **–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É** | –ü—Ä–∞–≤–∏—Ç—å 1 –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª | –°–æ–∑–¥–∞—Ç—å 1 –º–∞–ª–µ–Ω—å–∫–∏–π |
| **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | –°–ª–æ–∂–Ω–æ | –õ–µ–≥–∫–æ (isolated) |
| **–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** | –ù–µ—Ç | –î–∞ (—Å–µ—Ä–≤–∏—Å—ã) |
| **–¢–∏–ø–∏–∑–∞—Ü–∏—è** | –ß–∞—Å—Ç–∏—á–Ω–∞—è | –ü–æ–ª–Ω–∞—è |
| **Error handling** | –í–µ–∑–¥–µ try-catch | –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π |
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | console.log | –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ |

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ª–æ–∫–∞–ª—å–Ω–æ
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã
3. ‚úÖ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å production
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ–∏—á–∏ –∏—Å–ø–æ–ª—å–∑—É—è –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
5. ‚úÖ –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –∫–æ–≥–¥–∞ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è

---

**–í–æ–ø—Ä–æ—Å—ã?** –°–º. [DEVELOPMENT.md](DEVELOPMENT.md) –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ issue.

–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2026-01-07

